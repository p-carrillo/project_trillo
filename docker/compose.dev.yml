services:
  mariadb:
    image: mariadb:11.4.5
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: trillo
      MARIADB_USER: trillo
      MARIADB_PASSWORD: trillo
    ports:
      - '3310:3306'
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ['CMD-SHELL', 'mariadb -h 127.0.0.1 -uroot -proot -e "SELECT 1" >/dev/null 2>&1']
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 25s

  backend:
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 3000
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_USER: trillo
      DB_PASSWORD: trillo
      DB_NAME: trillo
      MCP_API_KEY: change-me
      MCP_ACCESS_TOKEN: ''
      JWT_ACCESS_SECRET: change-me-in-production
      JWT_ACCESS_EXPIRES_IN: 86400
      LOG_LEVEL: info
    depends_on:
      mariadb:
        condition: service_healthy
    ports:
      - '3000:3000'
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://127.0.0.1:3000/health/ready').then((response)=>process.exit(response.ok?0:1)).catch(()=>process.exit(1))"
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  web:
    build:
      context: ..
      dockerfile: docker/web.Dockerfile
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - '8080:80'
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://127.0.0.1/health/live']
      interval: 10s
      timeout: 5s
      retries: 10

  web-dev:
    image: node:22-alpine
    working_dir: /app
    environment:
      PNPM_HOME: /pnpm
      PATH: /pnpm:$PATH
      CHOKIDAR_USEPOLLING: 'true'
      WATCHPACK_POLLING: 'true'
      VITE_API_PROXY_TARGET: http://backend:3000
    command: >
      sh -c "corepack enable &&
      pnpm install --no-frozen-lockfile &&
      cd apps/web &&
      pnpm dev --host 0.0.0.0 --port 5173"
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - '5173:5173'
    volumes:
      - ..:/app
      - web_pnpm_store:/pnpm/store
      - web_node_modules:/app/node_modules
      - web_app_node_modules:/app/apps/web/node_modules
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://127.0.0.1:5173']
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  mariadb_data:
  web_pnpm_store:
  web_node_modules:
  web_app_node_modules:
