services:
  mariadb:
    image: mariadb:11.4.5
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:?DB_ROOT_PASSWORD is required}
      MARIADB_DATABASE: ${DB_NAME:?DB_NAME is required}
      MARIADB_USER: ${DB_USER:?DB_USER is required}
      MARIADB_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ['CMD-SHELL', 'mariadb -h 127.0.0.1 -uroot -p$$MARIADB_ROOT_PASSWORD -e "SELECT 1" >/dev/null 2>&1']
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 25s

  backend:
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    environment:
      HOST: 0.0.0.0
      PORT: 3000
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_USER: ${DB_USER:?DB_USER is required}
      DB_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
      DB_NAME: ${DB_NAME:?DB_NAME is required}
      MCP_API_KEY: ${MCP_API_KEY:?MCP_API_KEY is required}
      MCP_ACCESS_TOKEN: ${MCP_ACCESS_TOKEN:-}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:?JWT_ACCESS_SECRET is required}
      JWT_ACCESS_EXPIRES_IN: ${JWT_ACCESS_EXPIRES_IN:-86400}
      AUTH_REGISTER_ENABLED: ${AUTH_REGISTER_ENABLED:-false}
      HTTP_API_KEY: ${HTTP_API_KEY:-}
      LOG_LEVEL: info
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://127.0.0.1:3000/health/ready').then((response)=>process.exit(response.ok?0:1)).catch(()=>process.exit(1))"
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  web:
    build:
      context: ..
      dockerfile: docker/web.Dockerfile
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - '3002:80'
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://127.0.0.1/health/live']
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  mariadb_data: